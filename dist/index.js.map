{"version":3,"sources":["../src/constants.ts","../src/client.ts"],"names":["uuidv4"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * InkCop Exchange Client - 常量定义\n */\n\n/** 默认配置 */\nexport const DEFAULT_CONFIG = {\n  autoReconnect: true,\n  maxReconnectAttempts: 5,\n  reconnectDelay: 3000,\n  debug: false,\n} as const;\n\n/** SSE 事件名称 */\nexport const SSE_EVENTS = {\n  CONNECTED: 'connected',\n  APP_ONLINE: 'app_online',\n  APP_OFFLINE: 'app_offline',\n  DATA_UPDATE: 'data_update',\n  MESSAGE: 'message',\n} as const;\n\n/** API 端点 */\nexport const API_ENDPOINTS = {\n  EVENTS: '/events',\n  RELAY: '/relay',\n  GET_TOOLS: '/get_tools',\n} as const;\n\n","/**\n * InkCop Exchange Client - 核心客户端类\n * 框架无关的 Exchange 服务客户端\n */\n\nimport { v4 as uuidv4 } from 'uuid';\nimport { DEFAULT_CONFIG, SSE_EVENTS, API_ENDPOINTS } from './constants';\nimport type {\n  ConnectionStatus,\n  ExchangeClientConfig,\n  NormalizedConfig,\n  ServerStatus,\n  Tool,\n  LibraryInfo,\n  KnowledgeBaseInfo,\n  SendChatOptions,\n  CallToolOptions,\n  StreamChunk,\n  ToolCallResult,\n  ToolCallStartEvent,\n  ToolExecutionResult,\n  RelayMessage,\n  ServerStreamMessage,\n  ServerCompleteMessage,\n} from './types';\nimport type { ExchangeClientEventMap, EventListener, EventName, MessageLogEntry } from './events';\n\n/**\n * InkCop Exchange 客户端\n * 用于与 Exchange 服务器建立 SSE 连接并进行消息交互\n */\nexport class InkcopExchangeClient {\n  private config: NormalizedConfig;\n  private eventSource: EventSource | null = null;\n  private status: ConnectionStatus = 'disconnected';\n  private serverStatus: ServerStatus | null = null;\n  private reconnectAttempts = 0;\n  private reconnectTimer: ReturnType<typeof setTimeout> | null = null;\n\n  // 事件监听器存储\n  private listeners: Map<EventName, Set<EventListener<unknown>>> = new Map();\n\n  // 消息日志（调试用）\n  private messageLogs: MessageLogEntry[] = [];\n  private maxLogEntries = 100;\n\n  constructor(config: ExchangeClientConfig) {\n    this.config = this.normalizeConfig(config);\n    this.log('Client initialized', this.config);\n  }\n\n  // ==================== 公开 API ====================\n\n  /**\n   * 连接到 Exchange 服务器\n   */\n  async connect(): Promise<boolean> {\n    if (this.status === 'connected') {\n      this.log('Already connected');\n      return true;\n    }\n\n    if (this.status === 'connecting') {\n      this.log('Connection in progress');\n      return false;\n    }\n\n    this.setStatus('connecting');\n\n    return new Promise((resolve) => {\n      try {\n        const sseUrl = `${this.config.baseUrl}${API_ENDPOINTS.EVENTS}?id=${encodeURIComponent(this.config.clientId)}`;\n        this.log('Connecting to', sseUrl);\n\n        this.eventSource = new EventSource(sseUrl);\n        this.setupEventSourceHandlers(resolve);\n      } catch (error) {\n        this.log('Connection failed', error);\n        this.setStatus('error', String(error));\n        resolve(false);\n      }\n    });\n  }\n\n  /**\n   * 断开连接\n   */\n  disconnect(): void {\n    this.log('Disconnecting...');\n    this.clearReconnectTimer();\n\n    if (this.eventSource) {\n      this.eventSource.close();\n      this.eventSource = null;\n    }\n\n    this.setStatus('disconnected');\n    this.serverStatus = null;\n    this.reconnectAttempts = 0;\n  }\n\n  /**\n   * 发送聊天消息\n   * @param content 当前用户消息内容\n   * @param options 选项，包括对话历史、系统提示词、工具等\n   */\n  async sendChat(content: string, options: SendChatOptions = {}): Promise<string> {\n    const conversationId = options.conversationId || uuidv4();\n\n    const message: RelayMessage = {\n      type: 'chat',\n      conversation_id: conversationId,\n      client_id: [this.config.clientId],\n      message: {\n        content,\n        role: 'user',\n        ...(options.systemPrompt && { system_prompt: options.systemPrompt }),\n        ...(options.tools && options.tools.length > 0 && { tools: options.tools }),\n        ...(options.messages && options.messages.length > 0 && { messages: options.messages }),\n      },\n    };\n\n    await this.postRelay(message);\n    return conversationId;\n  }\n\n  /**\n   * 调用工具\n   */\n  async callTool(\n    toolName: string,\n    args: Record<string, unknown>,\n    options: CallToolOptions = {},\n  ): Promise<string> {\n    const conversationId = options.conversationId || uuidv4();\n\n    const message: RelayMessage = {\n      type: 'tool_call',\n      conversation_id: conversationId,\n      client_id: [this.config.clientId],\n      message: {\n        tool_name: toolName,\n        arguments: args,\n      },\n    };\n\n    await this.postRelay(message);\n    return conversationId;\n  }\n\n  // ==================== 状态查询 ====================\n\n  getStatus(): ConnectionStatus {\n    return this.status;\n  }\n\n  getServerStatus(): ServerStatus | null {\n    return this.serverStatus;\n  }\n\n  isConnected(): boolean {\n    return this.status === 'connected';\n  }\n\n  isAppOnline(): boolean {\n    return this.serverStatus?.appOnline ?? false;\n  }\n\n  getTools(): Tool[] {\n    return this.serverStatus?.tools ?? [];\n  }\n\n  getLibraries(): LibraryInfo[] {\n    return this.serverStatus?.libraries ?? [];\n  }\n\n  getKnowledgeBases(): KnowledgeBaseInfo[] {\n    return this.serverStatus?.knowledgeBases ?? [];\n  }\n\n  getClientId(): string {\n    return this.config.clientId;\n  }\n\n  getMessageLogs(): MessageLogEntry[] {\n    return [...this.messageLogs];\n  }\n\n  clearMessageLogs(): void {\n    this.messageLogs = [];\n  }\n\n  // ==================== 事件系统 ====================\n\n  on<K extends EventName>(event: K, listener: EventListener<ExchangeClientEventMap[K]>): this {\n    if (!this.listeners.has(event)) {\n      this.listeners.set(event, new Set());\n    }\n    const listeners = this.listeners.get(event);\n    if (listeners) {\n      listeners.add(listener as EventListener<unknown>);\n    }\n    return this;\n  }\n\n  off<K extends EventName>(event: K, listener: EventListener<ExchangeClientEventMap[K]>): this {\n    const eventListeners = this.listeners.get(event);\n    if (eventListeners) {\n      eventListeners.delete(listener as EventListener<unknown>);\n    }\n    return this;\n  }\n\n  once<K extends EventName>(event: K, listener: EventListener<ExchangeClientEventMap[K]>): this {\n    const onceListener = ((data: ExchangeClientEventMap[K]) => {\n      this.off(event, onceListener);\n      listener(data);\n    }) as EventListener<ExchangeClientEventMap[K]>;\n    return this.on(event, onceListener);\n  }\n\n  private emit<K extends EventName>(event: K, data: ExchangeClientEventMap[K]): void {\n    const eventListeners = this.listeners.get(event);\n    if (eventListeners) {\n      eventListeners.forEach((listener) => {\n        try {\n          listener(data);\n        } catch (error) {\n          console.error(`[ExchangeClient] Error in event listener for ${event}:`, error);\n        }\n      });\n    }\n  }\n\n  /**\n   * 销毁实例，清理所有资源\n   */\n  destroy(): void {\n    this.disconnect();\n    this.listeners.clear();\n    this.messageLogs = [];\n    this.log('Client destroyed');\n  }\n\n  // ==================== 内部方法 ====================\n\n  private normalizeConfig(config: ExchangeClientConfig): NormalizedConfig {\n    return {\n      baseUrl: config.baseUrl.replace(/\\/$/, ''), // 移除末尾斜杠\n      clientId: config.clientId || `client-${uuidv4().slice(0, 8)}`,\n      autoReconnect: config.autoReconnect ?? DEFAULT_CONFIG.autoReconnect,\n      maxReconnectAttempts: config.maxReconnectAttempts ?? DEFAULT_CONFIG.maxReconnectAttempts,\n      reconnectDelay: config.reconnectDelay ?? DEFAULT_CONFIG.reconnectDelay,\n      debug: config.debug ?? DEFAULT_CONFIG.debug,\n    };\n  }\n\n  private setStatus(status: ConnectionStatus, error?: string): void {\n    this.status = status;\n    this.emit('connection:status', { status, error });\n\n    if (status === 'disconnected') {\n      this.emit('connection:disconnected', undefined as never);\n    } else if (status === 'error' && error) {\n      this.emit('connection:error', new Error(error));\n    }\n  }\n\n  private log(...args: unknown[]): void {\n    if (this.config.debug) {\n      console.log('[ExchangeClient]', ...args);\n    }\n  }\n\n  private addLog(direction: 'send' | 'receive', data: unknown): void {\n    const entry: MessageLogEntry = {\n      direction,\n      data,\n      timestamp: Date.now(),\n    };\n\n    this.messageLogs.unshift(entry);\n\n    if (this.messageLogs.length > this.maxLogEntries) {\n      this.messageLogs = this.messageLogs.slice(0, this.maxLogEntries);\n    }\n\n    this.emit(direction === 'send' ? 'raw:send' : 'raw:receive', entry);\n  }\n\n  private setupEventSourceHandlers(resolveConnect: (success: boolean) => void): void {\n    if (!this.eventSource) return;\n\n    this.eventSource.onopen = () => {\n      this.log('SSE connection opened');\n    };\n\n    // 监听 connected 事件\n    this.eventSource.addEventListener(SSE_EVENTS.CONNECTED, (event) => {\n      this.handleConnectedEvent(event);\n      resolveConnect(true);\n    });\n\n    // 监听 app_online 事件\n    this.eventSource.addEventListener(SSE_EVENTS.APP_ONLINE, (event) => {\n      this.handleAppOnlineEvent(event);\n    });\n\n    // 监听 app_offline 事件\n    this.eventSource.addEventListener(SSE_EVENTS.APP_OFFLINE, (event) => {\n      this.handleAppOfflineEvent(event);\n    });\n\n    // 监听 data_update 事件\n    this.eventSource.addEventListener(SSE_EVENTS.DATA_UPDATE, (event) => {\n      this.handleDataUpdateEvent(event);\n    });\n\n    // 监听 message 事件\n    this.eventSource.addEventListener(SSE_EVENTS.MESSAGE, (event) => {\n      this.handleMessageEvent(event);\n    });\n\n    this.eventSource.onerror = () => {\n      if (this.eventSource?.readyState === EventSource.CLOSED) {\n        this.log('SSE connection closed');\n        this.setStatus('disconnected');\n        this.scheduleReconnect();\n      } else {\n        this.log('SSE connection error, attempting recovery...');\n      }\n    };\n  }\n\n  private handleConnectedEvent(event: MessageEvent): void {\n    try {\n      const data = JSON.parse(event.data as string);\n      this.addLog('receive', { event: 'connected', data });\n\n      this.serverStatus = {\n        clientId: data.clientId || this.config.clientId,\n        serverId: data.serverId || '',\n        appOnline: data.appOnline || false,\n        tools: data.tools || [],\n        libraries: data.libraries || [],\n        knowledgeBases: data.knowledgeBases || [],\n      };\n\n      this.setStatus('connected');\n      this.reconnectAttempts = 0;\n      this.emit('connection:connected', this.serverStatus);\n\n      this.log('Connected to server', this.serverStatus);\n    } catch (error) {\n      this.log('Failed to parse connected event', error);\n      this.addLog('receive', event.data);\n    }\n  }\n\n  private handleAppOnlineEvent(event: MessageEvent): void {\n    try {\n      const data = JSON.parse(event.data as string);\n      this.addLog('receive', { event: 'app_online', data });\n\n      if (this.serverStatus) {\n        this.serverStatus.appOnline = true;\n        if (data.tools) this.serverStatus.tools = data.tools;\n        if (data.libraries) this.serverStatus.libraries = data.libraries;\n        if (data.knowledgeBases) this.serverStatus.knowledgeBases = data.knowledgeBases;\n        this.emit('app:online', this.serverStatus);\n      }\n\n      this.log('App online', data);\n    } catch (error) {\n      this.log('Failed to parse app_online event', error);\n      this.addLog('receive', event.data);\n    }\n  }\n\n  private handleAppOfflineEvent(event: MessageEvent): void {\n    try {\n      const data = JSON.parse(event.data as string);\n      this.addLog('receive', { event: 'app_offline', data });\n\n      if (this.serverStatus) {\n        this.serverStatus.appOnline = false;\n      }\n\n      this.emit('app:offline', undefined as never);\n      this.log('App offline');\n    } catch (error) {\n      this.log('Failed to parse app_offline event', error);\n      this.addLog('receive', event.data);\n    }\n  }\n\n  private handleDataUpdateEvent(event: MessageEvent): void {\n    try {\n      const data = JSON.parse(event.data as string);\n      this.addLog('receive', { event: 'data_update', data });\n\n      if (this.serverStatus) {\n        if (typeof data.appOnline === 'boolean') {\n          this.serverStatus.appOnline = data.appOnline;\n        }\n        if (data.tools) this.serverStatus.tools = data.tools;\n        if (data.libraries) this.serverStatus.libraries = data.libraries;\n        if (data.knowledgeBases) this.serverStatus.knowledgeBases = data.knowledgeBases;\n        this.emit('app:data-update', this.serverStatus);\n      }\n\n      this.log('Data updated', data);\n    } catch (error) {\n      this.log('Failed to parse data_update event', error);\n      this.addLog('receive', event.data);\n    }\n  }\n\n  private handleMessageEvent(event: MessageEvent): void {\n    try {\n      const data = JSON.parse(event.data as string);\n      this.addLog('receive', { event: 'message', data });\n\n      // 处理流式消息（ExchangeStreamMessage 格式）\n      // 格式: { content, finished, chunk_index, conversation_id, message_index? }\n      if ('chunk_index' in data && typeof data.content === 'string') {\n        const streamData = data as ServerStreamMessage & { message_index?: number };\n        const chunk: StreamChunk = {\n          content: streamData.content,\n          chunkIndex: streamData.chunk_index,\n          finished: streamData.finished,\n          conversationId: streamData.conversation_id,\n          messageIndex: streamData.message_index,\n        };\n\n        this.emit('message:stream', chunk);\n\n        if (streamData.finished) {\n          // 流式消息完成时，也发送 complete 事件\n          this.emit('message:complete', {\n            role: 'assistant',\n            content: '', // 流式消息的完整内容由调用方累积\n            conversationId: streamData.conversation_id,\n            finished: true,\n            messageIndex: streamData.message_index,\n          });\n        }\n        return;\n      }\n\n      // 处理完整消息响应\n      const completeData = data as ServerCompleteMessage & { message_index?: number };\n      if (completeData.type === 'chat' && completeData.message) {\n        const content = String(completeData.message.content || completeData.message.text || '');\n        const finished = Boolean(completeData.message.finished);\n        const hasToolCalls = Boolean(completeData.message.has_tool_calls);\n        const messageIndex = completeData.message_index;\n\n        this.emit('message:complete', {\n          role: 'assistant',\n          content,\n          conversationId: completeData.conversation_id || '',\n          finished,\n          hasToolCalls,\n          messageIndex,\n        });\n      }\n\n      // 处理工具调用开始事件\n      // 格式: { type: 'tool_call_start', tool_calls: [...], message_index, conversation_id }\n      if (completeData.type === 'tool_call' && completeData.message) {\n        // 检查是否是工具调用开始\n        if (\n          'tool_calls' in completeData.message &&\n          Array.isArray(completeData.message.tool_calls)\n        ) {\n          const toolCalls = completeData.message.tool_calls as Array<{\n            id: string;\n            function: { name: string; arguments: string };\n          }>;\n          const startEvent: ToolCallStartEvent = {\n            conversationId: completeData.conversation_id || '',\n            toolCalls: toolCalls.map((tc) => ({\n              id: tc.id,\n              name: tc.function.name,\n              arguments: JSON.parse(tc.function.arguments || '{}'),\n            })),\n            messageIndex: (completeData.message.message_index as number) || 0,\n          };\n          this.emit('tool:start', startEvent);\n          return;\n        }\n\n        // 检查是否是工具执行结果\n        if ('tool_call_id' in completeData.message) {\n          const msg = completeData.message as {\n            tool_call_id: string;\n            tool_name?: string;\n            content?: string;\n            success?: boolean;\n            message_index?: number;\n          };\n          const resultEvent: ToolExecutionResult = {\n            conversationId: completeData.conversation_id || '',\n            toolCallId: msg.tool_call_id,\n            toolName: msg.tool_name || '',\n            result: msg.content || '',\n            success: msg.success ?? true,\n            messageIndex: msg.message_index || 0,\n          };\n          this.emit('tool:result', resultEvent);\n          return;\n        }\n\n        // 兼容旧的工具调用响应格式\n        const result: ToolCallResult = {\n          toolName: (completeData.message.tool_name as string) || '',\n          result: completeData.message,\n          success: !completeData.message.error,\n          conversationId: completeData.conversation_id || '',\n        };\n        this.emit('tool:complete', result);\n      }\n    } catch (error) {\n      this.log('Failed to parse message event', error);\n      this.addLog('receive', event.data);\n    }\n  }\n\n  private scheduleReconnect(): void {\n    if (!this.config.autoReconnect) {\n      this.log('Auto-reconnect disabled');\n      return;\n    }\n\n    if (this.reconnectAttempts >= this.config.maxReconnectAttempts) {\n      this.log('Max reconnect attempts reached');\n      this.setStatus('error', 'Max reconnect attempts reached');\n      return;\n    }\n\n    this.reconnectAttempts++;\n    const delay = this.config.reconnectDelay * this.reconnectAttempts;\n\n    this.log(\n      `Scheduling reconnect in ${delay}ms (attempt ${this.reconnectAttempts}/${this.config.maxReconnectAttempts})`,\n    );\n\n    this.reconnectTimer = setTimeout(() => {\n      this.log('Attempting reconnect...');\n      void this.connect();\n    }, delay);\n  }\n\n  private clearReconnectTimer(): void {\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer);\n      this.reconnectTimer = null;\n    }\n  }\n\n  private async postRelay(message: RelayMessage): Promise<void> {\n    this.addLog('send', { endpoint: 'POST /relay', data: message });\n\n    try {\n      const response = await fetch(`${this.config.baseUrl}${API_ENDPOINTS.RELAY}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(message),\n      });\n\n      const result = await response.json();\n      this.addLog('receive', { endpoint: 'POST /relay response', result });\n\n      if (!response.ok) {\n        const errorMessage = (result as { error?: string }).error || `HTTP ${response.status}`;\n        this.log('Relay failed', errorMessage);\n\n        if (message.type === 'chat') {\n          this.emit('message:error', {\n            message: errorMessage,\n            conversationId: message.conversation_id,\n          });\n        } else if (message.type === 'tool_call') {\n          this.emit('tool:error', {\n            toolName: (message.message as { tool_name: string }).tool_name,\n            message: errorMessage,\n            conversationId: message.conversation_id,\n          });\n        }\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      this.log('Relay error', errorMessage);\n\n      if (message.type === 'chat') {\n        this.emit('message:error', {\n          message: errorMessage,\n          conversationId: message.conversation_id,\n        });\n      } else if (message.type === 'tool_call') {\n        this.emit('tool:error', {\n          toolName: (message.message as { tool_name: string }).tool_name,\n          message: errorMessage,\n          conversationId: message.conversation_id,\n        });\n      }\n    }\n  }\n\n  /**\n   * 从服务器获取工具列表\n   */\n  async fetchTools(): Promise<Tool[]> {\n    try {\n      const response = await fetch(`${this.config.baseUrl}${API_ENDPOINTS.GET_TOOLS}`);\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n\n      const data = await response.json();\n      this.addLog('receive', { endpoint: 'GET /get_tools', data });\n\n      if (data.tools && Array.isArray(data.tools)) {\n        if (this.serverStatus) {\n          this.serverStatus.tools = data.tools;\n        }\n        return data.tools;\n      }\n\n      return [];\n    } catch (error) {\n      this.log('Failed to fetch tools', error);\n      return [];\n    }\n  }\n}\n"]}